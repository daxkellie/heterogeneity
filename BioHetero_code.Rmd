---
title: "Biological Heterogeneity"
author: "DK"
date: "01/04/2020"
output:
  html_document:
    highlight: pygments
    theme: lumen
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

```{r fresh list of bel air, echo = FALSE}
rm(list=ls())
```

```{r packages, message = FALSE, warning = FALSE, error = FALSE}

# packages
# library(tidyverse)
# library(lme4)
# library(lmerTest)
# library(MuMIn)
# library(rptR)
# library(brms)

pacman::p_load(tidyverse, lme4, lmerTest, MuMIn, rstan, brms, rptR, tidybayes, coda)

# helping running rstan (brms) models

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```


# Load Data Sets

```{r}
data_CSV <- read.csv("Datasets/CSV_microcosms/data/milcu_etal2017.csv", header = TRUE)
data_NutNet <- read.csv("Datasets/NutNet/data/Model2.SEM.plot.data.csv", header = TRUE)
data_biomass <- read.csv("Datasets/RichnessDrought/data/biomass_1.2.csv", header = TRUE)
# more to add here


```


# Nutrient Network (NutNet)
Anderson et al. (2018) model </b>

Test effect of Herbivory (FENCE; yes/no) & Eutrophication (Fertilizer; yes/no) on C, N, P & K

Model includes treatment variable Fence, as well as environmental measures of MAP, MAT and SOLAR.INS  
MAP = mean annual precipitation  
MAT = mean annual temperature  
SOLAR.INS = solar insolation  

Used AIC model comparison to determine final model

```{r}
data_NutNet %>% glimpse()
data_NutNet %>% head(5)
```


## Repeatability Analysis

Frequency Distribution
```{r}
plot_frequencyDist <- function(df, variable) {
  
  fd.histogram <- ggplot(df, aes_string(x = variable)) + 
    guides(fill = F) # to remove the legend
  
  fd.histogram + 
    geom_histogram(binwidth = .4) + # binwidth tidies the data a bit
    labs(x = variable, y = "Frequency")
  
}
plot_frequencyDist(data_NutNet, "plant.NPK")
```

### Frequentist Model
```{r}
# REPLICATE variable
data_NutNet$REPLICATE <- paste0(data_NutNet$SITE, data_NutNet$TREATMENT)

# Frequentist model
model <- lmer(plant.NPK ~ TREATMENT + (1|SITE) + (1|REPLICATE), data = data_NutNet)
summary(model)

hist(resid(model)) # Note that there is an outlier

# Total Variance
var(data_NutNet$plant.NPK)
```

### Bayesian Model
```{r}
# Bayesian model
modelb <-brm(plant.NPK ~ TREATMENT + (1|SITE) + (1|REPLICATE), data = data_NutNet,
             chains = 2, cores = 2) # you can do more but 2 chains will be fine

summary(modelb)

# I have not used brms for a while - so testing a few functions
bayes_R2(modelb)
get_variables(modelb)
```


```{r}
# getting posterior of random effects for each
# blups <- ranef(modelb, summary = F)

# get all posterior samples
post <- posterior_samples(modelb)
names(post)

# these three are important
# [1] "b_Intercept"                                  "b_TREATMENTFence"                            
#  [3] "b_TREATMENTNPK"                               "b_TREATMENTNPK_Fence"                        
#  [5] "sd_REPLICLATE__Intercept"                     "sd_SITE__Intercept"                          
#  [7] "sigma"         

# we get what we need - for random effect
V_rep <-post$sd_REPLICATE__Intercept^2 # making it variance
V_site <-post$sd_SITE__Intercept^2
V_res <- post$sigma^2 
    # Why is sigma equal to residual variance? 
    # Don't we need sigma to calculate error of estimates in plots?
```


```{r}
# we need to calculate variance for fixed effects - this is not so easy
# get a posterior for fixed effect bits (you need to get this as one - it will be difficult to decompose these - why?)
# I cannot seem to get a model matrix from brms so I am going to use lmer

# get a data frame of different posterior of fixed effects
post_fix <- as.data.frame(t(post[,1:4]))

# get a posterior of fixed effects
V_fix <-  map_dbl(post_fix, ~ var(as.vector(. %*% t(model@pp$X))) )

# mcmc object (from coda package)
post_mat <- as.mcmc(data.frame(V_rep, V_site, V_res, V_fix, row.names = NULL))

summary(post_mat)
plot(post_mat)

head(post_mat)

post_mat %>% data.frame %>% mutate(V_all = V_rep + V_site + V_res + V_fix,
                                   P_rep = V_rep/(V_rep + V_site + V_res + V_fix),
                                   P_site = V_site/(V_rep + V_site + V_res + V_fix),
                                   P_res = V_res/(V_rep + V_site + V_res + V_fix),
                                   P_fix = V_fix/(V_rep + V_site + V_res + V_fix),
                                   P_all = P_rep + P_site + P_res + P_fix)          ->  post_mat2

```


```{r}
# Dax to make figure
library(ggthemes)

# Create table of variance values
prop_post <- post_mat2 %>% 
  mutate(
    iteration = 1:length(post_mat2$P_all),
    Variable = paste("plant.NPK")# make a col to represent each test
  ) %>%
  select(P_rep, P_site, P_res, P_fix, iteration, Variable) %>%
  pivot_longer(c(-Variable, -iteration), values_to = "Variance") # flip the table

str(prop_post)
head(prop_post)
 
# Summarised SE & mean values
prop_post.sem <- prop_post %>% 
  group_by(name) %>% 
  summarise(mean = mean(Variance),
            sem = sd(Variance) / sqrt(n()),
            lower = (mean - sem),
            upper = (mean + sem)) %>%
  mutate(Variable = paste("plant.NPK"))
str(prop_post.sem)

prop_post$name <- as.factor(prop_post$name)
prop_post.sem %>% 
  ggplot(aes(x = Variable, y = mean, fill = name, colour = name)) + 
  # stat_summary(fun.y = mean, geom = "bar", position = "stack") +
  geom_bar(stat = "identity", position = "stack", width = 0.2, alpha = .6, size = 1) +
  geom_errorbar(aes(ymin = lower, 
                    ymax = upper),
                stat = "identity",
                width=.1,                    # Width of the error bars
                position="identity", colour = "black") + 
  coord_cartesian(ylim = c(0, 1.2)) + scale_fill_ptol() + scale_colour_ptol()
?scale_fill_brewer


# Dax - go to here (not all exp and code are useful)
# https://github.com/paul-buerkner/brms
# https://mjskay.github.io/tidybayes/articles/tidy-brms.html
# https://www.rensvandeschoot.com/tutorials/brms-started/
# and learn and do more exploration with this and other ones

mean(V_rep) # this is posterior mean (variance of random effect estimate)
posterior.mode(V_rep) # posterior mode because variation is not normally distributed

# post_mat note:
#posterior should add up to one

```

Repeatability
```{r}
rep2 <- rptGaussian(plant.NPK ~ TREATMENT + (1|SITE),
                 grname = c("SITE", "Fixed", "Residual"), 
                 data = data_NutNet,
                 ratio = FALSE,
                 nboot = 100, parallel = TRUE, adjusted = FALSE)

rep2
```


## Plot Variance Components
Data wrangling
```{r}
varTable_NutNet <- as.data.frame(rep2$R) # extract variance components in dataframe
varTable_NutNet <- varTable_NutNet %>% 
  rename(., Location = SITE) %>% # rename SITE
  mutate(
    Data = paste("NutNet") # Add data identifier column
  ) %>%
  pivot_longer(-Data, names_to = "Components", values_to = "Variance") # flip the table

# add percent of total variance column
varTable_NutNet$percentVar <- varTable_NutNet$Variance/(sum(varTable_NutNet$Variance))*100 
```

*Plot*
```{r}
varTable_NutNet %>%
  ggplot(aes(x = Data, y = percentVar, fill = Components)) + 
  geom_bar(stat = "identity", position = "stack", width = .4) +
  geom_text(aes(label = paste0(as.character(Components), "\n",  round(percentVar, 0), "%")), 
            position = "stack", hjust = 1, size = 2, check_overlap = FALSE) + 
    scale_fill_brewer(palette = "Pastel1", na.value = "grey70") + 
    coord_flip() + 
    theme_minimal(base_size = 12) + 
    theme(axis.title = element_blank(), panel.grid.major.y = element_blank(), 
          legend.position = "top")

```


# Controlled Systematic Variability (CSV)
Microcosms experiment  
Milcu et al. (2018)  
Sites: 14 European Labs  

<br/>

Tested effect of presence of legume species on grass species. Introducted genetic and environmental variability.  <br/>

Rename columns
```{r}
data_CSV <- rename(data_CSV,
                   Legume = Treat..legume.,
                   CSV = Treat..controlled.systematic.variabiliy.,
                   biomass_Seed = Biom.dm..g...seed.,
                   biomass_Shoot = Biom.dm..g...shoot.,
                   biomass_Root = Biom.dm..g...root.,
                   biomass_Total = Biom.dm..g...total.,
                   ratio_RootShoot = Root.shoot,
                   N.shoot = N.shoot....,
                   C.shoot = C.shoot....
                   )

# They removed outliers but I'll keep these in.
```

```{r}
data_CSV %>% glimpse()
data_CSV %>% head(10)
```


## Repeatability Analysis

Shinichi's model
```{r}
data_CSV$Replicate <-  paste0(data_CSV$Block, data_CSV$Lab) # add block x lab variable

model <- lmer(biomass_Seed ~ Legume*Method.comm + (1|Lab) + (1|CSV)+
                (1| Replicate), 
                data = data_CSV)
                
summary(model)                
```
Frequency distribution of data
```{r}
plot_frequencyDist(data_CSV, "biomass_Seed")
```

```{r}
rep3 <- rptGaussian(biomass_Seed ~ Legume*Method.comm + (1|Lab) + (1|CSV) + (1| Replicate),
                   grname = c("Lab", "CSV", "Replicate", "Fixed", "Residual"), 
                   data = data_CSV,
                   ratio = FALSE,
                   nboot = 10, parallel = FALSE, adjusted = FALSE)

rep3
```

## Plot Variance Components
Data wrangling
```{r}
varTable_CSV <- as.data.frame(rep3$R) # extract variance components in dataframe
varTable_CSV <- varTable_CSV %>% 
  rename(., Location = Lab) %>% # rename SITE
  mutate(
    Data = paste("CSV") # Add data identifier column
  ) %>%
  pivot_longer(-Data, names_to = "Components", values_to = "Variance") # flip the table

# add percent of total variance column
varTable_CSV$percentVar <- varTable_CSV$Variance/(sum(varTable_CSV$Variance))*100 
```


# Biodiversity x Drought
```{r}
data_biomass %>% glimpse()
data_biomass %>% head(5)
```

# PLOT
```{r}
varTable <- rbind(varTable_NutNet, varTable_CSV)
```
```{r}
varTable %>%
  ggplot(aes(x = Data, y = percentVar, fill = Components)) + 
  geom_bar(stat = "identity", position = "stack", width = .4) +
  geom_text(aes(label = paste0(as.character(Components), "\n",  round(percentVar, 0), "%")), 
            position = "stack", hjust = 1, size = 2, check_overlap = FALSE) + 
    scale_fill_brewer(palette = "Pastel1", na.value = "grey70") + 
    coord_flip() + 
    theme_minimal(base_size = 12) + 
    theme(axis.title = element_blank(), panel.grid.major.y = element_blank(), 
          legend.position = "top")

```


# Replicated Models from Papers

## Anderson et al. (2018)
They use Log Response Ratio of total NPK between Control & Fertilizer treatment as Dependent Variable
```{r}
# get sum of DV
table_NPK_Fert <- data_NutNet %>% 
  group_by(SITE, NPK.ADDED, FENCE, MAP, MAT, SOLAR.INS, N.DEPOSITION) %>% 
  select(SITE, NPK.ADDED, plant.NPK, plant.N, plant.P, plant.K) %>%
  summarise(total.NPK = sum(plant.NPK))

# Prepare table for pivot_wider()
table_NPK_Fert$NPK.ADDED <- as.character(table_NPK_Fert$NPK.ADDED)
table_NPK_Fert$NPK.ADDED <- recode(table_NPK_Fert$NPK.ADDED, "0" = "Control", '1' = "Fertilizer")

# Calulate Log Response Ratio of DV (Control vs Fertilizer effect)
table_NPK_Fert <- 
  table_NPK_Fert %>% 
  pivot_wider(names_from = NPK.ADDED, values_from = total.NPK) %>%
  group_by(SITE) %>%
  mutate(
    LRR_Fertilizer = log(Fertilizer/Control)
  )
```

```{r}
# Anderson et al. model
model <- lm(LRR_Fertilizer ~ FENCE + MAT + MAT + SOLAR.INS + N.DEPOSITION + FENCE:MAT, 
              data = table_NPK_Fert)

anova(model)
summary(model)
```



## Milcu et al. (2018)
#### Their model
```{r}
model <- lmer(biomass_Seed ~ Legume * Lab * CSV + 
                (1|Block/Method.comm), 
                data = data_CSV)
```
